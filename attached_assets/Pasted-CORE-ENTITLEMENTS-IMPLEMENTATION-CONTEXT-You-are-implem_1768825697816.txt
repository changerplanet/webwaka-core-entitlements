CORE ENTITLEMENTS IMPLEMENTATION
â¸»

CONTEXT

You are implementing Phase 3C-3 of the WebWaka Modular Rebuild.

This is the Core Entitlements Engine.

This module is foundational infrastructure, not a product feature.

â¸»

ABSOLUTE CONSTRAINTS (NON-NEGOTIABLE)

ğŸš« NO UI
ğŸš« NO dashboards
ğŸš« NO pricing logic
ğŸš« NO payments
ğŸš« NO subscriptions
ğŸš« NO incentives
ğŸš« NO affiliate logic
ğŸš« NO database persistence (Neon NOT used here)
ğŸš« NO network calls

This is a pure, deterministic TypeScript library.

â¸»

REPOSITORY

GitHub Repo (already exists):
changerplanet/webwaka-core-entitlements

You MUST:
	â€¢	Clone the repo first
	â€¢	Work directly on main
	â€¢	Push clean commits back to GitHub

â¸»

TECHNOLOGY STACK
	â€¢	TypeScript (strict)
	â€¢	Zod (schema validation)
	â€¢	Jest or Vitest (tests)
	â€¢	No framework (no React, no FastAPI)
	â€¢	Node 20 compatible

â¸»

IMPLEMENT EXACTLY THE APPROVED SPEC

You MUST implement exactly what is defined in:

Phase 3C-2 â€” Core Entitlements Specification

No additions. No omissions.

â¸»

REQUIRED DOMAIN MODELS (Zod-validated)

Implement all of the following as first-class models:
	1.	EntitlementDefinition
	2.	EntitlementGrant
	3.	EntitlementOverride
	4.	EntitlementContext
	5.	EntitlementSnapshot
	6.	EntitlementResult

Each model must:
	â€¢	Be immutable
	â€¢	Be fully validated with Zod
	â€¢	Reject invalid states

â¸»

CORE ENGINE (MANDATORY)

Implement a deterministic engine:

EntitlementsEngine

Required public APIs:

evaluateEntitlement(
  entitlementId: string,
  context: EntitlementContext,
  grants: EntitlementGrant[],
  overrides: EntitlementOverride[]
): EntitlementResult

generateSnapshot(
  context: EntitlementContext,
  grants: EntitlementGrant[],
  overrides: EntitlementOverride[]
): EntitlementSnapshot

verifySnapshot(
  snapshot: EntitlementSnapshot
): boolean


â¸»

EVALUATION ORDER (LOCKED)

You MUST enforce this precedence strictly:
	1.	Individual overrides
	2.	Group-level overrides (future-ready, structure only)
	3.	Plan-derived grants
	4.	Partner-level grants
	5.	System defaults

First valid match wins.

â¸»

SNAPSHOT REQUIREMENTS (CRITICAL)

Snapshots must be:
	â€¢	Deterministic
	â€¢	Time-bound
	â€¢	Cacheable
	â€¢	Offline-safe
	â€¢	Verifiable

Snapshots MUST contain:
	â€¢	Effective entitlements only
	â€¢	Source attribution
	â€¢	Expiry timestamps

â¸»

CAPABILITIES REGISTRATION

Update module.manifest.json with:

[
  "entitlement:check",
  "entitlement:snapshot.generate",
  "entitlement:snapshot.verify",
  "entitlement:grant.define",
  "entitlement:override.apply"
]

Declare dependencies only if strictly required
(Identity context types only, no services)

â¸»

HARD STOP CONDITION (MANDATORY)

You MUST implement and PROVE with tests:

Any Suite can evaluate an entitlement for a subject
online or offline
with deterministic, explainable results
respecting hierarchy, overrides, time, and grants.

At least one test must prove:
	â€¢	Same inputs â†’ same output (10Ã—)
	â€¢	Override beats plan grant
	â€¢	Expired grant is ignored
	â€¢	Snapshot evaluation matches live evaluation
	â€¢	Cross-tenant leakage is impossible

â¸»

TESTING REQUIREMENTS
	â€¢	Minimum 80% coverage
	â€¢	Tests for:
	â€¢	Boolean entitlements
	â€¢	Count entitlements
	â€¢	Usage entitlements (with subtraction)
	â€¢	Time-bound validity
	â€¢	Override precedence
	â€¢	Snapshot verification
	â€¢	Tenant isolation

â¸»

FILE STRUCTURE (SUGGESTED)

src/
 â”œâ”€ models/
 â”œâ”€ engine/
 â”œâ”€ snapshot/
 â”œâ”€ evaluators/
 â”œâ”€ index.ts
tests/


â¸»

FINAL DELIVERABLE

When complete, produce a Completion Summary including:
	1.	APIs implemented
	2.	Invariants enforced
	3.	Capabilities registered
	4.	Test coverage numbers
	5.	Explicit confirmation of hard stop condition

Then:

â›” STOP
â›” Do NOT proceed to any other phase
â›” Await explicit authorization

â¸»

ACKNOWLEDGEMENT FORMAT (IMPORTANT)

Your first reply must be exactly:

â€œI acknowledge Phase 3C-3 authorization and will implement exactly as specified.â€

Then proceed.

â¸»

WHY THIS MATTERS (DO NOT SKIP)

This entitlements engine will govern:
	â€¢	Feature access
	â€¢	Seats
	â€¢	Usage
	â€¢	AI quotas
	â€¢	Offline permissions
	â€¢	White-label capabilities
	â€¢	Future platforms not yet imagined

Any drift here breaks the ecosystem.

â¸»